# -*- coding: utf-8 -*-
# @Author: Xuguoliang
# @Date:   2025-12-17 10:00:00
# @Version: 1.2.0

import json
import random
from typing import Dict, Any, List

class Classifier:
    """
    智能分类系统
    负责构建 ICL 提示词并解析 LLM 结果
    """
    
    def __init__(self, llm_client, config):
        self.llm_client = llm_client
        self.config = config
        
        # 多级分类体系
        self.taxonomy = {
            # =========================================================
            # 核心玩法与逻辑 (Gameplay & Logic)
            # =========================================================
            "程序战斗": [
                # 关键词：技能、数值、Buff、战斗状态
                "技能释放故障(按键无反应/CD不转/无法施放)",
                "战斗数值异常(伤害NaN/无伤害/判定丢失/治疗失效)",
                "Buff/Debuff逻辑错误(无限持续/不生效/图标残留)",
                "战斗同步异常(位置回拉/血量显示不一致)",
                "受击/死亡反馈缺失(无僵直/无击退/无法复活)",
                "武器系统故障(换弹失败/射击无声/弹道丢失)",
                "自动战斗/辅助瞄准失效(乱打/不攻击)",
                "召唤物/宠物AI逻辑异常(不攻击/发呆)",
                "PVP机制漏洞(平衡性Bug/系统级判定错误)"
            ],
            "程序关卡": [
                # 关键词：流程、副本、触发器、刷怪
                "副本流程卡死(不刷怪/门不开/无法进入下一阶段)",
                "任务目标计数器故障(杀怪不计数/采集无进度)",
                "关卡交互机关失效(电梯不动/装置无法操作)",
                "副本结算异常(不弹出结算/奖励未到账/黑屏)",
                "传送点/复活点逻辑错误(传送到虚空/无限坠落)",
                "剧情/过场动画触发失败或卡住",
                "关卡内空气墙阻挡(导致流程无法进行)",
                "组队/副本状态同步错误(队友看不见/门状态不同步)"
            ],
            "策划": [
                # 关键词：配置、文案、设计、数值合理性
                "数值配置不合理(怪物太强/掉率太低/价格错误)",
                "文案/描述错误(错别字/多语言缺失/描述与效果不符)",
                "任务指引不清/寻路位置配置错误",
                "玩法规则设计缺陷(体验极差/逻辑死循环)",
                "活动奖励配置错误(奖励物品不对/无法领取)",
                "商城/礼包内容配置不符",
                "NPC行为/站位配置不当(非Bug类的设计问题)",
                "系统解锁条件配置错误(等级不够却解锁)"
            ],

            # =========================================================
            # 角色表现 (Character Presentation)
            # =========================================================
            "角色美术": [
                # 关键词：模型结构、贴图资源、静态外观
                "角色/时装模型穿模(衣服穿透/肢体扭曲)",
                "模型结构错误(破面/顶点拉伸/接缝明显)",
                "贴图资源缺失或错误(马赛克/紫块/画错)",
                "角色配件/挂件位置偏移(悬空/反向)",
                "捏脸模型显示不一致(大厅与局内不同)",
                "模型LOD层级错误(远看面数崩坏)",
                "特殊形态(变身)模型显示异常"
            ],
            "TA角色渲染": [
                # 关键词：Shader、材质质感、光照响应
                "角色皮肤/肤色渲染异常(死黑/惨白/塑料感)",
                "材质质感错误(金属太亮/布料像塑料)",
                "角色光照响应错误(逆光全黑/边缘光异常)",
                "Shader特效异常(流光丢失/自发光过曝)",
                "半透明材质渲染错误(头发/纱裙排序不对)",
                "角色阴影投射异常(脸上脏阴影/无阴影)",
                "特定环境下角色变色/过曝"
            ],
            "美术动画": [
                # 关键词：动作、骨骼、姿态
                "动作僵硬/不自然(滑步/内八/抽搐)",
                "动画衔接生硬(瞬切/无过渡)",
                "待机/交互动作播放错误(T-Pose/卡住)",
                "表情/口型动画缺失",
                "跑动/跳跃姿态异常",
                "载具驾驶/乘坐动作错位"
            ],
            "TA动画物理": [
                # 关键词：物理结算、布料、刚体
                "裙摆/布料物理异常(穿模/反重力掀起)",
                "头发/飘带物理效果鬼畜(乱抖/拉伸)",
                "物理碰撞结算错误(卡进地里/被弹飞)",
                "布娃娃(Ragdoll)系统异常(尸体抽搐)",
                "胸部/臀部物理晃动异常"
            ],

            # =========================================================
            # 场景与环境 (Environment & World)
            # =========================================================
            "场景美术": [
                # 关键词：场景模型、地形、静态碰撞
                "场景模型穿模/悬空/接缝",
                "地形贴图拉伸/裂缝/错误",
                "场景物件(树木/石头)模型丢失或白模",
                "静态空气墙/碰撞体缺失(掉出地图/穿墙)",
                "场景地表植被浮空/错位",
                "建筑结构模型错误"
            ],
            "TA场景渲染": [
                # 关键词：环境光影、天气、LOD
                "场景整体光照异常(过曝/过暗/闪烁)",
                "LOD切换突变(远近模型跳变/闪烁)",
                "天空盒/云层渲染错误",
                "雾效/大气渲染异常(分层/颜色不对)",
                "阴影渲染错误(锯齿/闪烁/断裂)",
                "场景加载/流失异常(黑块/蓝块)"
            ],
            "TA物件技术": [
                # 关键词：物件材质、独立Prop
                "家具/小物件贴图材质错误",
                "物件半透明/玻璃材质渲染异常",
                "物件被遮挡/剔除逻辑错误",
                "动态物件(旗帜/灯笼)表现异常"
            ],
            "TA场景交互表现": [
                # 关键词：水面、交互反馈、脚印
                "水面渲染与交互异常(无波纹/反射错误/黑水)",
                "植被交互反馈缺失(不倒伏/不摇摆)",
                "角色脚印/地表痕迹缺失或错误",
                "场景破坏/破碎效果异常",
                "雨雪在物体表面的覆盖效果错误"
            ],
            "TA全局光照": [
                # 关键词：GI、烘焙、漏光
                "全局光照(GI)异常(室内漏光/黑斑)",
                "环境光遮蔽(AO)缺失或过重",
                "光照探针/反射探针错误(反射环境不对)",
                "烘焙贴图(Lightmap)错乱",
                "实时光照与烘焙光照过渡生硬"
            ],

            # =========================================================
            # 视觉与性能 (Visuals & Performance)
            # =========================================================
            "TA画质表现": [
                # 关键词：清晰度、后处理、整体观感
                "画面模糊/清晰度不足(分辨率低)",
                "抗锯齿效果差(边缘锯齿/闪烁)",
                "屏幕后处理异常(景深全糊/运动模糊过重)",
                "色彩断层/色差/饱和度异常",
                "不同画质档位表现不一致(低画质黑屏)"
            ],
            "TA外观氛围": [
                # 关键词：滤镜、色调、风格
                "场景色调/滤镜风格异常",
                "特定区域(副本/水下)氛围丢失",
                "昼夜变换氛围过渡错误",
                "屏幕特效(中毒/濒死)氛围渲染错误"
            ],
            "程序基础体验": [
                # 关键词：崩溃、卡死、底层交互
                "客户端崩溃(Crash)/闪退/无响应",
                "严重卡死(画面冻结/无法操作)",
                "网络连接故障(断线/重连失败/延迟高)",
                "底层输入失效(触摸/键盘无反应)",
                "设备异常(严重发热/耗电快)",
                "声音/音频底层丢失(全无声/杂音)"
            ],
            "程序客户端性能优化": [
                # 关键词：掉帧、卡顿、资源
                "游戏掉帧/帧率不稳定(FPS低)",
                "特定场景/操作卡顿(GC卡顿/加载卡顿)",
                "内存占用过高/泄漏(OOM)",
                "画质/帧率设置选项不生效",
                "加载速度过慢/IO瓶颈"
            ],
            
            # =========================================================
            # 其他职能 (Others)
            # =========================================================
            "程序UI": [
                "UI控件错位/重叠/遮挡",
                "文字显示异常(乱码/缺字/排版错误)",
                "图标/图片资源丢失(白块/红叉)",
                "UI交互无反馈(点击无效但非底层死机)",
                "红点提示逻辑错误(消不掉)",
                "屏幕适配问题(刘海遮挡/黑边)"
            ],
            "美术特效": [
                "技能/攻击特效丢失或显示错误",
                "粒子效果过曝/光污染",
                "场景氛围特效(雨雪粒子)异常",
                "UI特效/动效缺失"
            ],
            "TA-PC适配": [
                "PC版键鼠映射/操作异常",
                "PC版分辨率/窗口模式问题",
                "PC版特有渲染错误",
                "PC版启动/更新失败"
            ],
            "程序营地与家园": [
                "家园建造模式操作异常",
                "家具/建筑摆放逻辑错误",
                "蓝图保存/变现失败",
                "营地/家园特有交互功能失效"
            ]
        }
                        
    def _build_analysis_prompt(self, feedback: str) -> str:
        """
        构建第一阶段：技术分析 Prompt
        """
        category_defs = """
## 核心概念定义 (Reference)

### 1. 表现层 vs 逻辑层
- **表现层 (Visual/Asset)**: 看起来是错的，但功能可能正常。如模型穿模、贴图拉伸、光照过曝、特效颜色不对。通常归属 **美术** 或 **TA**。
- **逻辑层 (Logic/Function)**: 用起来是错的，或者根本没反应。如点击无效、技能放不出、怪不刷、掉出地图、数值计算错误。通常归属 **程序**。

### 2. 关键区分点
- **GUI vs 程序UI**: 
  - 静态的“丑、乱、遮挡” -> **GUI** (美术/设计问题)。
  - 动态的“点不动、算错、列表乱” -> **程序UI** (逻辑问题)。
  - **特例**: UI里的3D模型变黑/丢失 -> **TA/美术** (非UI逻辑)。
  
- **TA vs 美术**:
  - **TA**: 解决“技术原理”导致的显示问题。关键词：Shader错误、变粉(材质丢失)、变黑(光照/法线)、全局过曝、透明排序错误。
  - **美术**: 解决“制作内容”本身的错误。关键词：模型面数不对、骨骼蒙皮穿模、贴图画歪了、动作本身僵硬。

- **策划 vs 程序**:
  - **策划**: 配置错误。如掉率太低、怪太强、物品描述错、指引点配错位置。
  - **程序**: 机制失效。如怪无敌(状态机卡死)、任务无法完成(触发器失效)、技能CD异常。

- **QA兜底**:
  - 当问题描述为纯粹的“进不去”、“卡死”、“黑屏”且无更多细节时，归为 **QA** (现象)。

### 3. 判别规则（优先级从高到低）：
1) 先判定是“功能逻辑”还是“表现视觉”还是“底层体验/性能”还是“配置/设计”。
   - 功能逻辑：无法进入/无法交互/不刷怪/技能放不出/伤害不对/掉线/不能传送。
   - 表现视觉：黑白/过曝/马赛克/贴图错误/闪烁/穿模/倒影不对/水面不对。
   - 底层体验/性能：崩溃闪退/卡死无响应/FPS低/发热/内存溢出/下载更新失败。
   - 配置/设计：数值不合理/文案不对/奖励配置不符/规则体验差。

2) 再用“排他特征”做强区分：
   - 出现 GI/AO/Lightmap/漏光/黑斑/探针/反射探针：优先 TA全局光照。
   - 出现 分辨率/抗锯齿/景深/锐化/后处理/像素化/马赛克：优先 TA画质表现。
   - 出现 LOD跳变/天空盒/雾效分层/阴影锯齿闪烁/远景加载：优先 TA场景渲染。
   - 出现 水面反射/波纹/黑水/脚印/植被交互/破碎反馈：优先 TA场景交互表现。
   - 出现 角色肤色死黑/塑料感/头发半透明排序/边缘光/材质质感：优先 TA角色渲染。
   - 出现 走路滑步/动作抽搐/T-Pose/动作不播放：优先 美术动画；若强调布料/头发物理乱抖则优先 TA动画物理。
   - 出现 不刷怪/门不开/电梯卡/结算不弹/任务进度不走：优先 程序关卡。
   - 出现 技能CD/伤害NaN/Buff不生效/武器换弹射击异常：优先 程序战斗。
   - 出现 崩溃闪退/输入失灵/无声/断线重连失败：优先 程序基础体验。
   - 出现 掉帧/锁帧/设置不生效/内存泄漏/场景越玩越卡：优先 程序客户端性能优化。
   - 出现 红点消不掉/时装商店/邮箱/活动页面展示：优先 程序运营物料。
   - 出现 登录服务/服务器宕机/网关/数据库/回档：优先 程序服务器基建。
   - 出现 文案错/掉率/奖励/价格/解锁条件/玩法体验差：优先 策划。

3) 若描述同时命中“表现”和“逻辑”，以“阻断游戏”的逻辑问题优先（卡死/无法继续/无法进入/无法完成）。
4) 若仍然模糊，选择更具体的 TA/程序子域，而不是泛类（例如优先 TA全局光照 而不是 TA外观氛围）。

"""
        prompt = f"""
# Role
你是一个资深的游戏研发技术专家。你的任务是对玩家反馈的Bug进行深度的**技术归因分析**。

# Context
玩家反馈往往是表象的，你需要透过现象看本质。
你需要分三步进行思考：
1. **纯技术分析**：不考虑具体的分类标签，只分析Bug的现象、可能的技术成因（资源/逻辑/配置/渲染等）。
2. **大类建议**：基于分析，推荐可能的 1-3 个一级分类（Category）。
3. **细分建议**：基于分析，推荐可能的 2-4 个二级分类（Subcategory），供后续决策参考。

# Reference Definitions
{category_defs}

# Examples (ICL)
示例 1
User Feedback: "背包界面人物预览模型全黑，只剩轮廓。"
输出：
【技术分析】用户反馈的是UI界面中的3D模型显示异常（全黑）。这通常不是UI逻辑错误（UI已经显示出来了），而是3D渲染层面的问题。可能原因包括：UI场景的光照配置丢失、模型材质Shader在UI相机下不兼容、或者模型贴图资源损坏。这属于典型的渲染/资源表现层问题。
【大类建议】TA（首选）、美术、程序（次选）。
【细分建议】TA资产光影（变黑）、TA角色渲染（隐身/丢失）、程序UI（数据加载异常）、GUI（资源层）。

示例 2
User Feedback: "任务奖励的领取按钮点了没反应，重复点击也不到账。"
输出：
【技术分析】这是一个典型的功能逻辑失效问题。按钮可见但交互无效，可能是客户端UI点击事件未触发、客户端向服务器发送请求失败、或者服务器逻辑处理异常（未发货）。这属于程序逻辑层问题，与美术表现无关。
【大类建议】程序（首选）、策划（次选）。
【细分建议】程序UI（交互失效）、程序系统（奖励领取失败）、策划（配置错误）、程序服务器基建（网络丢包）。

示例 3
User Feedback: "商城首页很多图标变成红叉/白块，图片加载不出来。"
输出：
【技术分析】UI图标显示为红叉或白块，这是引擎标准的“资源缺失”占位符。说明UI逻辑正常加载了图片控件，但索引到的图片资源文件不存在、路径错误或未打入包中。这是静态资源索引问题。
【大类建议】GUI（首选）、程序（次选）、TA。
【细分建议】GUI（UI静态资源缺失）、程序UI（UI数据加载失败）、TA资产光影（贴图格式异常）。

# Task
请对以下玩家反馈进行三层结构的分析。

# Input
User Feedback: "{feedback}"

# Output Format
请严格按照以下格式输出纯文本（不要输出JSON）：
【技术分析】...
【大类建议】...
【细分建议】...
"""
        return prompt

    def _build_classification_prompt(self, feedback: str, analysis: str) -> str:
        """
        构建第二阶段：分类 Prompt (基于分析报告)
        """
        taxonomy_json = json.dumps(self.taxonomy, ensure_ascii=False, indent=2)
        
        prompt = f"""
# Role
你是一个资深的游戏研发QA专家。你已经获得了一份关于Bug的**技术分析报告**。
这份报告包含了对Bug成因的分析，以及可能的分类建议。
你的任务是：结合玩家反馈原文 + 技术分析报告，严格遵守提示词里的重要分类原则，对照下方的 Taxonomy，做出**最终的分类决策**。

#重要分类原则
- 渲染问题首先考虑引擎与TA
- 尽量不要分类给策划，策划与程序的bug比较相似，优先考虑分类给程序
- 不好分类的问题首先考虑分类引擎和TA，因为他们有进一步判断bug原因的能力

# Taxonomy
{taxonomy_json}

# Examples (ICL)
示例 1
User Feedback: "背包界面人物预览模型全黑，只剩轮廓。"
Technical Analysis:
【技术分析】用户反馈的是UI界面中的3D模型显示异常（全黑）。这通常不是UI逻辑错误（UI已经显示出来了），而是3D渲染层面的问题。可能原因包括：UI场景的光照配置丢失、模型材质Shader在UI相机下不兼容、或者模型贴图资源损坏。这属于典型的渲染/资源表现层问题。
【大类建议】TA（首选）、美术、程序（次选）。
【细分建议】TA资产光影（变黑）、TA角色渲染（隐身/丢失）、程序UI（数据加载异常）、GUI（资源层）。
Output JSON:
{{
  "category": "TA资产光影",
  "subcategory": "UI内3D模型/Prefab光影丢失(变黑)",
  "priority": "Medium",
  "reason": "技术分析指出是UI内3D预览渲染/光影问题。虽然大类建议有多个，但细分建议中的'TA资产光影'与Taxonomy中的'UI内3D模型/Prefab光影丢失(变黑)'完全匹配，且最符合'模型全黑'的特征。"
}}

示例 2
User Feedback: "任务奖励的领取按钮点了没反应，重复点击也不到账。"
Technical Analysis:
【技术分析】这是一个典型的功能逻辑失效问题。按钮可见但交互无效，可能是客户端UI点击事件未触发、客户端向服务器发送请求失败、或者服务器逻辑处理异常（未发货）。这属于程序逻辑层问题，与美术表现无关。
【大类建议】程序（首选）、策划（次选）。
【细分建议】程序UI（交互失效）、程序系统（奖励领取失败）、策划（配置错误）、程序服务器基建（网络丢包）。
Output JSON:
{{
  "category": "程序UI",
  "subcategory": "UI交互失效/点击无反应(逻辑)",
  "priority": "High",
  "reason": "技术分析确认是交互逻辑问题。大类锁定'程序'。在细分建议中，'程序UI'（交互失效）比'程序系统'更直接对应'点了没反应'的现象。"
}}

示例 3
User Feedback: "商城首页很多图标变成红叉/白块，图片加载不出来。"
Technical Analysis:
【技术分析】UI图标显示为红叉或白块，这是引擎标准的“资源缺失”占位符。说明UI逻辑正常加载了图片控件，但索引到的图片资源文件不存在、路径错误或未打入包中。这是静态资源索引问题。
【大类建议】GUI（首选）、程序（次选）、TA。
【细分建议】GUI（UI静态资源缺失）、程序UI（UI数据加载失败）、TA资产光影（贴图格式异常）。
Output JSON:
{{
  "category": "GUI",
  "subcategory": "UI静态资源缺失(红叉/白图)",
  "priority": "Medium",
  "reason": "技术分析明确指出是静态资源缺失导致的红叉/白块。GUI大类下的'UI静态资源缺失(红叉/白图)'是最佳匹配。"
}}

# Input Data
1. **User Feedback**: "{feedback}"
2. **Technical Analysis**: 
{analysis}

# Task
基于技术分析报告，从 Taxonomy 中选择**唯一最匹配**的一级分类 (category) 和二级分类 (subcategory)。
**决策原则**:
1. 优先参考【技术分析】中的成因判断（是资源、逻辑还是配置？）。
2. 查看【细分建议】中是否有与 Taxonomy 完全对应的条目。
3. 如果分析报告建议了多个方向，请根据 Taxonomy 中细分类别的关键词（如"逻辑"、"资源层"、"现象"）进行排查，选择最精准的一个。

# Output Format
{{
    "category": "一级分类名称",
    "subcategory": "二级分类名称",
    "priority": "High/Medium/Low",
    "reason": "简述分类理由 (引用技术分析结论)"
}}
"""
        return prompt

    def classify(self, feedback: str) -> Dict[str, Any]:
        """
        执行双阶段分类任务: 分析 -> 分类
        """
        # Phase 1: Analysis
        try:
            analysis_prompt = self._build_analysis_prompt(feedback)
            analysis_response = self.llm_client.chat(analysis_prompt)
            technical_analysis = analysis_response.strip()
        except Exception as e:
            print(f"[Classifier Analysis Error] {str(e)}")
            technical_analysis = "分析阶段失败，仅基于原始反馈分类。"

        # Phase 2: Classification
        try:
            classify_prompt = self._build_classification_prompt(feedback, technical_analysis)
            response = self.llm_client.chat(classify_prompt)
            
            # 清理可能的 Markdown 代码块标记
            cleaned_response = response.strip()
            if cleaned_response.startswith("```"):
                cleaned_response = cleaned_response.split("\n", 1)[1]
            if cleaned_response.endswith("```"):
                cleaned_response = cleaned_response.rsplit("\n", 1)[0]
                
            result = json.loads(cleaned_response)
            # 可选：将分析报告也放入结果中，便于调试或展示
            result["technical_analysis"] = technical_analysis
            return result
            
        except Exception as e:
            # 错误处理，返回兜底结构
            print(f"[Classifier Error] Processing failed: {str(e)}") 
            return {
                "category": "未分类",
                "subcategory": "解析失败",
                "priority": "Low",
                "reason": f"System Error: {str(e)}",
                "technical_analysis": technical_analysis
            }

    def generate_sub_subcategories(self, category: str, subcategory: str, feedbacks: List[str], max_samples: int = 50) -> List[str]:
        """
        根据反馈列表生成子子分类
        (已禁用: 一级二级分类已经足够详细)
        """
        return []

    def assign_sub_subcategory(self, feedback: str, options: List[str]) -> str:
        """
        为单条反馈分配子子分类 (Legacy)
        (已禁用)
        """
        return ""

    def batch_assign_sub_subcategories(self, feedbacks: List[str], options: List[str]) -> List[str]:
        """
        批量为反馈分配子子分类
        (已禁用)
        """
        return [""] * len(feedbacks)
