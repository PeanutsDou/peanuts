# -*- coding: utf-8 -*-
# @Author: Xuguoliang
# @Date:   2026-01-09 10:00:00
# @Version: 1.3.0

import json
import random
from typing import Dict, Any, List

class Classifier:
    """
    智能分类系统
    负责构建 ICL 提示词并解析 LLM 结果
    """
    
    def __init__(self, llm_client, config):
        self.llm_client = llm_client
        self.config = config
        
        # 多级分类体系
        self.taxonomy = {
                        "程序战斗": [
                            "战斗基础：含伤害结算流程、各个属性词条效果",
                            "AI：含AI编辑器",
                            "装备：含辅助瞄准、配件、改造",
                            "战斗相关道具：核芯、无人机、战术腰带、芯片、战术装备、战术耗材、武器皮肤战斗机制",
                            "战斗数值养成系统：拟态、潜能等",
                            "再生者相关：孢子、藤蔓飞跃",
                            ],
                        "程序关卡": [
                            "怪物基础：含布怪编辑器、技能编辑器",
                            "排行榜基础结构：仅提供基础结构支持，具体的排行榜由具体管线负责",
                            "组队与匹配",
                            "PVP竞技战斗：南希市、远星城、红杉镇、特训战场、庇护城、夏尔镇等",
                            "区域行动：包括每日行动、每周行动、联盟行动、挑战本、试炼本等，含其中的怪物、任务、机制、结算、奖励",
                            "营地关卡：含营地BOSS、动荡之城等",
                            "其他关卡：含辐射高校、整备突袭、物资运输等",
                            "场景负载均衡",
                            "服务器扩缩容机制",
                            ],
                        "程序营地和家园": [
                            "营地功能：基础功能、福利箱、靶场、营地NPC交易、成就、科技、红包、庇护城效果",
                            "营地玩法：打靶、搬砖、巡逻、擂台、丧尸围城、逃脱乐园、舞会",
                            "庄园建造：基础建造、公寓、同居、金库、蓝图、动植物、多人",
                            ],
                        "程序系统": [
                            "基础系统：背包、对象交互、奖励、成就、称号、邮件、大地图、小地图、设置",
                            "任务与指引：日程、个人任务、援助任务、生存手册、废土向导、指引与引导、精灵",
                            "社交：名片、好友、聊天（含语音聊天）、车队、陌生人交互",
                            "交易：交易之城、快捷购买",
                            "外围战斗：等级、职业、天赋、配方、合成、分解、修理、纳米塑材、武装强化、数值落后追赶",
                            "玩法系统：钓鱼、拍照、喷漆、宠物、食物、体温、体力、饥饿值、气力、感染值、健康值、图鉴、商会临时委托",
                            "新增与回流：角色创建、新手、回流、账号找回",
                            ],
                        "程序野外与大世界": [
                            "大世界基础结构：大世界场景划分、场景跳转、无缝切换、分线规则",
                            "大世界玩法：喂鹿、萤火虫、推雪球等",
                            "大世界怪物表现：蓝潮、远近VAT丧尸、翻越、攀爬、尸潮移动",
                            "海洋：海洋地图、信标任务、船只",
                            "大世界建造：基建、公路建造、公路导航",
                            "NPC相关：NPC对话、闲话、NPC动态系统",
                            "野外生存玩法：不明生物、心跳禁区、荒潮求生、探潮档案、绝命赏单、悬赏狩猎",
                            "资料片：资料片核心玩法、引入流程",
                            ],
                        "程序特性服": [
                            "特性服专属规则失效(等级上限/掉落规则错误)",
                            "跨服匹配/传输失败",
                            "赛季/剧本结算异常",
                            "专属活动/玩法未开启(X9/硬核服/月卡服)",
                            "地图加载页面问题"
                            ],
                        "程序运营需求": [
                            "商业化：商业化活动、商城、npc商店等",
                            "活跃：活跃活动、驱逐行动、南瓜精、消消乐小游戏、生存达人、希望报、杂志等",
                            "外部系统对接：计费、运营指令后台、渠道SDK、其他各类SDK对接",
                            "服务器合并",
                            ],
                        "程序运营物料": [
                            "角色外观/时装穿戴不生效",
                            "捏脸数据保存/同步失败",
                            "个性化定制功能失效(仿印/染色无法保存)",
                            "载具/家具特殊功能不触发(特效丢失/交互无效)",
                            "物料资源配置错误(图标不符/模型错误)",
                            "武器外观不正常(武器贴图丢失/特效错误)",
                            ],
                        "程序UI": [
                            "UI框架：含UI性能、UI编辑器",
                            "主界面：主界面布局、图标、界面自定义",
                            "UI Sign：头顶图标、伤害跳字",
                            "云文件系统",
                            "评论、聊天系统",
                            "操作界面显示不正常：按钮不发光、界面错位",
                            "地图界面问题：地图显示异常、无法传送",
                            "红点问题：红点显示异常、不能消失",
                            ],
                        "引擎系统与工具": [
                            "引擎底层崩溃(Crash/ANR/OOM)",
                            "内存泄漏/占用过高",
                            "资源加载失败(紫块/模型丢失/读条卡死)",
                            "跨平台兼容性问题(特定机型闪退/花屏)",
                            "引擎系统：场景管理、Meadow系统、远景系统等",
                            "引擎工具：场景编辑器、UE编辑器、模型编辑器、特效编辑器、过场动画编辑器、引擎自动化测试等",
                            ],
                        "程序美术渲染": [
                            "Shader编译/运行错误(材质变粉/模型变黑)",
                            "光照/阴影渲染异常(漏光/阴影闪烁/过曝)",
                            "后处理效果异常(景深/模糊/泛光错误)",
                            "天气/环境系统渲染错误(雨雪效果缺失/天空盒破损)",
                            "特效渲染层级/混合模式错误",
                            "Vulkan/Deferred等图形API相关问题"
                            ],
                        "程序工具与效率": [
                            "内部开发工具：启动器、导表工具、SVN、Git、代码资源分支管理、多语言翻译等",
                            "打包：打包、Patch、Orbit、Luna上传、测试服等特殊包体",
                            "内服：内服创建、分配、冒烟测试、稳定服、BPO环境等",
                            "自动化流程：CICD、Jenkins、开发机维护等",
                            ],
                        "程序服务器基建": [
                            "服务器宕机/无法连接",
                            "网络延迟/丢包/瞬移(Lag/Rubber-banding)",
                            "数据库读写错误(回档/数据丢失)",
                            "服务器引擎",
                            "网络与连接：玩家登录流程、玩家迁移、断线重连、网络延迟等",
                            "服务器搭建和维护：含提前测试服等",
                            "服务器体验与成本：含卡顿延迟、服务器成本、稳定性",
                            "时光机",
                            "推送功能",
                            ],
                        "程序客户端性能优化": [
                            "帧率过低/卡顿(掉帧/Freeze)",
                            "设备发热/耗电严重",
                            "场景/资源加载过慢",
                            "内存/显存占用过高导致闪退",
                            "物理/逻辑计算耗时过高",
                            "LOD/HLOD切换异常",
                            "客户端性能：总体性能问题跟进、资产规范、制作规范、性能风险评估、版本性能报告和优化方案",
                            "引擎性能优化：三线程、渲染合批、LOD、HLOD、高帧率模式、异步加载等",
                            ],
                        "程序基础体验": [
                            "物理：含基础碰撞、物理破碎等",
                            "动画：含动画图、IK、双人动作等",
                            "音效：音效播放、动画音效挂接等",
                            "角色控制：移动、游泳、卡住脱离等",
                            "寻路：含寻路图生成、怪物NPC寻路、飞行导航、海洋寻路等",
                            "相机控制",
                            "基础采集：采麻、石头、砍树",
                            ],
                        "GUI": [
                                "界面显示异常",
                                "图标/图片缺失",
                                "文字/排版错误",
                                "分辨率/适配问题",
                                "HUD显示错误",
                                "界面交互无反馈",
                                "UI元素重叠/遮挡",
                                "加载失败/黑白屏",
                                "界面模糊/过曝"
                            ],
                        "QA": [
                                "客户端崩溃/闪退",
                                "严重卡顿/掉帧",
                                "无法登录/连接失败",
                                "黑屏/白屏/花屏",
                                "手机发热/耗电快",
                                "安装/更新失败",
                                "弱网/断线重连"
                            ],
                        "TA-PC适配": [
                                "PC分辨率异常",
                                "窗口/全屏切换问题",
                                "键鼠操作失灵/冲突",
                                "PC画质选项失效",
                                "PC端崩溃/报错",
                                "模拟器兼容性问题"
                            ],
                        "TA全局光照": [
                                "全局光照(GI)异常",
                                "烘焙/Lightmap错误",
                                "阴影缺失/闪烁",
                                "环境光遮蔽(AO)异常",
                                "场景漏光/黑斑",
                                "室内外光影过渡突兀",
                                "四季效果问题。如雪地效果、覆盖区域等",
                                ""
                            ],
                        "TA副本渲染": [
                                "副本场景加载失败",
                                "Boss/怪物渲染异常",
                                "副本光照/迷雾错误",
                                "副本特有特效缺失",
                                "屏幕特效(白屏/闪烁)异常"
                            ],
                        "TA场景交互表现": [
                                "交互物高亮/提示缺失",
                                "物件破坏/物理反馈异常",
                                "场景物件穿模/悬空",
                                "植被/水体交互异常",
                                "地表/材质拼接缝隙"
                            ],
                        "TA场景渲染": [
                                "场景LOD/模型切换明显",
                                "植被/地表渲染异常",
                                "远景/天空盒加载失败",
                                "场景过度曝光/黑暗",
                                "贴图拉伸/错位",
                                "水面/反射渲染错误"
                            ],
                        "TA外观氛围": [
                                "时装/皮肤氛围不符",
                                "场景色调/滤镜错误",
                                "整体美术风格不统一",
                                "后处理效果(Post-processing)异常",
                                "画面爆闪/伪影"
                            ],
                        "TA物件技术": [
                                "物件材质精度丢失",
                                "模型面数/LOD异常",
                                "贴图流送/加载延迟",
                                "场景物件穿模/悬空",
                                "阴影/光照烘焙错误"
                            ],
                        "TA画质表现": [
                                "抗锯齿(AA)失效/锯齿感",
                                "图像锐化过度/不足",
                                "画面模糊/噪点严重",
                                "整体画质分级不生效",
                                "屏幕闪烁/撕裂"
                            ],
                        "TA角色表现": [
                                "捏脸系统显示异常",
                                "妆容/肤色渲染错误",
                                "角色体型调整无效",
                                "自定义饰品穿模/悬空",
                                "易容/预览显示错误",
                                "皮肤SSS材质异常",
                                "角色光影/自阴影错误",
                                "头发/眼球渲染异常",
                                "角色边缘光/高光过曝",
                                "角色模型丢失/隐身"
                            ],
                        "TA资产光影": [
                                "资产导入/路径错误",
                                "贴图格式/压缩异常",
                                "预制体(Prefab)光影丢失",
                                "材质球丢失/显示粉色"
                            ],
                        "TA材质细节": [
                                "材质模糊/马赛克",
                                "贴图缺失/错位",
                                "材质过曝/过暗",
                                "透明/反光材质异常",
                                "金属/布料质感错误"
                            ],
                        "策划": [
                                "任务流程卡死(无法交互/物品缺失/流程中断)",
                                "NPC/怪物刷新异常(不刷怪/刷在墙里/卡怪/无法被攻击)",
                                "关卡机制失效(机关/按键缺失/路点错误/电梯故障)",
                                "数值/奖励配置错误(过少/不发放/爆率异常/结算异常)",
                                "文案/描述与实际不符(错别字/语意不明/音效配置错误)",
                                "场景设计缺陷(空气墙/卡死点/掉出地图/位置不合理/母巢卡墙)",
                                "活动/功能开启时间或规则配置错误(规则不生效/时间不对)",
                                "道具/掉落物配置错误(位置/无法拾取/ID错误/旧道具出售)",
                                "指引/路点/寻路配置错误(地图标点丢失/传送点失效)",
                                "BOSS/怪物AI行为异常(站桩/瞬移/无敌状态不解除/仇恨机制错误)",
                                "NPC模型/位置异常(半身入土/穿模/悬空/隐身但可交互)",
                                "副本/活动流程异常(黑屏/无法退出/剧情触发失败)",
                                "界面/图标配置错误(显示了错误的物品/投影不符)",
                                "技能/武器数值配置错误(伤害过低/CD太长/描述不符)"
                            ],
                        "美术动画": [
                                "动作僵硬/不自然",
                                "模型穿模(衣物/发型)",
                                "角色滑步/漂移",
                                "物理/骨骼结算异常",
                                "表情/口型不匹配",
                                "待机/移动动作错误",
                                "载具交互/骑乘动作错误"
                            ],
                        "引擎渲染管线": [
                                "光照/阴影异常",
                                "场景过曝/过暗",
                                "水面/反射渲染错误",
                                "植被/地表加载失败",
                                "天气/环境氛围错误",
                                "模型透视/遮挡关系"
                            ],
                        "美术特效": [
                                "特效显示异常(颜色错误/位置偏移/过曝)",
                                "光效过曝/光污染",
                                "粒子/贴图错误",
                                "技能/打击特效表现异常(非功能失效)",
                                "特效颜色/位置不对",
                                "拖尾/爆炸效果异常",
                                "场景/环境特效异常"
                            ],
                        "场景美术": [
                                "场景模型穿模/破面",
                                "贴图拉伸/错位",
                                "场景布局/摆放不合理",
                                "碰撞体缺失(空气墙)",
                                "物件悬空/位置错误",
                                "门“开”“关”异常",
                                "空气墙",
                                "地板",
                                "场景物件穿模/悬空",
                            ],
                        "角色美术": [
                                "角色面部崩坏(黑脸/眼球)",
                                "发型/服装穿模",
                                "皮肤/时装显示错误",
                                "武器/挂件模型异常",
                                "角色模型丢失/隐身",
                                "捏脸/妆容显示错误",
                                "服装,时装",
                                "头，腿，手，脚等提及身体部位",
                                "人物，怪物，boss"
                            ],
                        "角色动画": [
                                "物理碰撞体积异常",
                                "击飞/受击反馈错误",
                                "布料/毛发飘动异常",
                                "载具物理反馈错误",
                                "角色滑步/漂移",
                                "刚体/柔体模拟错误"
                            ],
        }

    def _build_prompt(self, feedback: str) -> str:
        """
        构建面向 Deepseek 的 ICL 提示词
        """
        taxonomy_json = json.dumps(self.taxonomy, ensure_ascii=False, indent=2)
        
        prompt = f"""
# Role
你是一个资深的游戏研发QA专家，负责对玩家反馈进行精准分类和预处理。

# Taxonomy
请参考以下分类体系进行分类：
{taxonomy_json}

# Task
请对给定的玩家反馈进行分析，提取关键信息，并按 JSON 格式输出。

# Rules
1. **prediction_class**: 必须属于一级分类。
2. **attribution**: 必须属于对应的一级分类下的二级分类。如果不匹配，可根据语境生成最合适的简短描述。
3. **priority**: 根据问题严重程度评估 (High: 阻断性/崩溃/严重舆情; Medium: 功能缺陷/体验问题; Low: 建议/轻微显示)。

分类注意事项：
- 最核心优先级最高的一点！要注重对bug描述整体语义的理解，在语义理解的基础上总结出核心问题，再借助分类关键词对照分类！
- 对于不好分辨根因的bug，可以优先分配给引擎和TA相关职能，因为他们有进一步准确判断bug原因的能力。
- 涉及到“反击”、“振刀”之类PVE里独有的战斗机制问题，要归类为“程序关卡”，而不是“程序战斗”。
- 所有地图加载的问题，都要分到“程序特性服”下。
- 严格区分“策划”与“程序”：
    - **策划 (Design)**: 仅包含 **非技术性的逻辑/配置错误**。
        - 典型案例: 数值错误、文案错误、资源配置错误（图标配错）、**逻辑死胡同导致的卡关**（如钥匙在锁着的门里）。
        - **切记**: 凡是涉及物理碰撞（卡墙/掉出地图）、运行时逻辑（按键无反应/技能失效）、表现异常（穿模/黑块）等 **技术性故障**，一律 **不归为策划**，应归为程序或美术相关分类。
- 涉及到“点”、“线”、“面”、“带”、“窗口”等偏向描述一个2D几何图形的描述，一般为程序UI或GUI。
- 涉及到“模型”、“角色”、“人物”、“怪物”、“boss”、“时装”、“服装”、“衣服”等类似人体，或人形动物相关的描述，一般为角色美术相关分类。凡是涉及角色模型（身体/服装/挂件）的显示异常（穿模、破面、黑脸、隐身），只要不影响角色移动和战斗功能，优先归类为角色美术。
- 凡是涉及 模型、贴图、动作、特效 的显示异常，但 不影响游戏核心功能流程 的，优先归类为【美术】相关分类。如果因为显示问题导致无法游戏（如模型遮挡全屏），则可能涉及【程序】或【QA】。
- 涉及地图场景中的静态物件（树木、建筑、地面、墙体、灯光等环境元素）的穿模、悬空、贴图错误。注意与‘TA场景渲染’以及程序相关的区分：如果是单个物件错是场景美术，如果是整体光影错是TA，如果涉及到游戏逻辑问题（如物体遮挡玩家），则可能涉及程序。

# Examples
User: "鸳鸯鬼戏副本，盖头环节不能开枪射击，没有射击键"
Assistant:
{{
    "prediction_class": "策划",
    "attribution": "关卡机制失效(机关/按键缺失/路点错误/电梯故障)",
    "priority": "High",
    "reason": "副本特定环节交互缺失，导致流程无法进行"
}}

User: "101开发区邮箱，车库，等基础设施卡进了庄园地基位置了没有改善。"
Assistant:
{{
    "prediction_class": "场景美术",
    "attribution": "物件悬空/位置错误",
    "priority": "Medium",
    "reason": "场景物件摆放位置错误，穿模严重，影响视觉表现"
}}

User: "在人物面向有水面时，人物的倒影并不是产生在水面，而是紧跟在人物建模旁边"
Assistant:
{{
    "prediction_class": "TA场景渲染",
    "attribution": "水面/反射渲染错误",
    "priority": "Medium",
    "reason": "渲染逻辑错误，倒影位置异常，影响画面真实感"
}}

# Input
User: "{feedback}"
Assistant:
"""
        return prompt

    def classify(self, feedback: str) -> Dict[str, Any]:
        """
        执行分类任务
        """
        prompt = self._build_prompt(feedback)
        
        try:
            # 使用 chat 接口
            response = self.llm_client.chat(prompt)
            
            # 清理可能的 Markdown 代码块标记
            cleaned_response = response.strip()
            if cleaned_response.startswith("```"):
                cleaned_response = cleaned_response.split("\\n", 1)[1]
            if cleaned_response.endswith("```"):
                cleaned_response = cleaned_response.rsplit("\\n", 1)[0]
                
            return json.loads(cleaned_response)
        except Exception as e:
            # 错误处理，返回兜底结构
            print(f"[Classifier Error] Processing failed: {str(e)}") # 打印错误信息以便调试
            return {
                "prediction_class": "未分类",
                "attribution": "解析失败",
                "priority": "Low",
                "reason": f"System Error: {str(e)}"
            }
